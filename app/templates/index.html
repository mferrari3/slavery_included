{% extends "base.html" %}

{% block content %}

<style type="text/css">
  {% include "style.css" %}

    </style>

<link rel= "stylesheet"
      type= "text/css"
      href= "/static/css/tooltip.css">


<!-- BODY -->
<body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
<script src="/static/js/d3-tip.js"></script>


<div class="container"  align="center" >

  <h1 align="center"> {{ comp_name }}</h1>

  <div class="row">

    <div class="col-6">
     	<p class="text-muted"> {{ watson_description }}
	</p>
        {{ watson_table|safe }}
    </div>

    <div class="col-6" id="d3map">
      <h6>This company may support forced labor in its supply chain. Explore the interactive map to see where materials may come from</h6>
      <div id="map"></div>
    </div>

  </div>

  <div class="row">

    <div class="col"></div>

    <div class="col">
      <div id="variable-select" style="padding: 20px;">
        <select id = "variable">
          {% for g in goodlist %}
          <option value="{{g}}">{{g}}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

</div>

<div class="container"  align="center" >

  <div class="row text-center">

    <div class="col-md-4">
      <!-- CHROME EXTENSION -->
	<span class="fa-stack fa-4x">
          <i class="fa fa-circle fa-stack-2x text-primary"></i>
          <i class="fa fa-chrome fa-stack-1x fa-inverse"></i>
        </span>
	    
	<h4 class="service-heading">Chrome Extension</h4>
        <p class="text-muted">
	      Our chrome extension is now available! <a href="https://bit.ly/2EO0rWs"  target="_blank"> HERE</a></p>

    </div>

    <div class="col-md-4">

	    <!-- TWEETING -->
            <span class="fa-stack fa-4x">
              <i class="fa fa-circle fa-stack-2x text-primary"></i>
              <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
            </span>

	    <h4 class="service-heading">Tweet to  {{ comp_name }}</h4>
	    <h4>
	      <iframe src={{ tweet }}
		      width="140"
		      height="28"
		      title="Twitter Tweet Button"
		      style="border: 0; overflow: hidden;">
	      </iframe>

	    </h4>
	    <p class="text-muted">We know that you want your purchases to be honest.  Let companies know you care.</p>
    </div>

    <div class="col-md-4">
            <span class="fa-stack fa-4x">
              <i class="fa fa-circle fa-stack-2x text-primary"></i>
              <i class="fa fa-question fa-stack-1x fa-inverse"></i>
            </span>
            <h4 class="service-heading">Learn More</h4>
            <p class="text-muted">Read more about our sources.</p>
    </div>


    
  </div>

  
  
</div>
<div class="container"  align="center" >

  <div class="row text-center">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Questions</th>
      <th>Company_response</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Requires their first tier suppliers to implement standards that are in line with the company's supply chain standards</td>
      <td>Neutral</td>
    </tr>
    <tr>
      <td>Requires that no fees be charged during recruitment processes conducted throughout their supply chains</td>
      <td>Positive</td>
    </tr>
    <tr>
      <td>Has publicly demonstrated their awareness of and commitment to addressing forced labor</td>
      <td>Negative</td>
    </tr>
    <tr>
      <td>Trains suppliers on risks, policies, and standards related to human trafficking and forced labor</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>Participated in one or more multi-stakeholder or industry initiatives focused on forced labor and human trafficking</td>
      <td>Neutral</td>
    </tr>
    <tr>
      <td>Adopted more stringent policies on eliminating foreign worker deductions</td>
      <td>Positive</td>
    </tr>
    <tr>
      <td>Ensures recruitment agencies in their supply chains are audited</td>
      <td>Negative</td>
    </tr>
    <tr>
      <td>Ensures workers sign contracts directly with suppliers to avoid exploitation through recruitment agencies</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>Ensures remedy is provided to supply chain workers whose rights have been violated</td>
      <td>Neutral</td>
    </tr>
    <tr>
      <td>Provides a detailed map of supply chain</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>Seeks external audits of their supply chain</td>
      <td>Positive</td>
    </tr>
    <tr>
      <td>Relocates forced labourers to safer and higher quality dormitories</td>
      <td>Positive</td>
    </tr>
    <tr>
      <td>Demonstrate strong practices with respect to training and stakeholder engagement</td>
      <td>Negative</td>
    </tr>
    <tr>
      <td>Has processes to trace its supply chain of beyond it's first-tier suppliers</td>
      <td>Positive</td>
    </tr>
    <tr>
      <td>Discloses names and locations of its first-tier suppliers, and some information on suppliers beyond its first tier</td>
      <td>Negative</td>
    </tr>
    <tr>
      <td>Demands its first-tier suppliers ensure that their own suppliers implement standards that are in line with the company's standards</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>Communicates its human trafficking and forced labor policies and standards to supply chain workers in their native languages</td>
      <td>Neutral</td>
    </tr>
    <tr>
      <td>The company has an accessible, formal grievance mechanism that facilitates the impartial reporting by suppliers' workers of workplace grievances and informs workers as to how to access the mechanism.</td>
      <td>Neutral</td>
    </tr>
  </tbody>
</table>
  </div>

  </div>


<script>
// initial configuration
const colorVariable = 'population';
const geoIDVariable = 'id';
const format = d3.format(',');

// set the tooltip
const tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(d => `<strong>Country: </strong><span class='details'>${d.properties.name}<br></span><strong>Forced Labor Score: </strong><span class='details'>${format(d[colorVariable])}</span>`);

// tip box location settings
tip.direction(function(d) {
  if (d.properties.name === 'Antarctica') return 'n';
  // Americas
  if (d.properties.name === 'Greenland') return 's';
  if (d.properties.name === 'Canada') return 'e';
  if (d.properties.name === 'USA') return 'e';
  if (d.properties.name === 'Mexico') return 'e';

// Europe
  if (d.properties.name === 'Iceland') return 's';
  if (d.properties.name === 'Norway') return 's';
  if (d.properties.name === 'Sweden') return 's';
  if (d.properties.name === 'Finland') return 's';
  if (d.properties.name === 'Russia') return 'w';
  // Asia
  if (d.properties.name === 'China') return 'w';
  if (d.properties.name === 'Japan') return 's';
  // Oceania
  if (d.properties.name === 'Indonesia') return 'w';
  if (d.properties.name === 'Papua New Guinea') return 'w';
  if (d.properties.name === 'Australia') return 'w';
  if (d.properties.name === 'New Zealand') return 'w';
  // otherwise if not specified
  return 'n';
})

tip.offset(function(d) { // [top, left]
  if (d.properties.name === 'Antarctica') return [0, 0];
  // Americas
  if (d.properties.name === 'Greenland') return [10, -10];
  if (d.properties.name === 'Canada') return [24, -28];
  if (d.properties.name === 'USA') return [-5, 8];
  if (d.properties.name === 'Mexico') return [12, 10];
  if (d.properties.name === 'Chile') return [0, -15];
  // Europe
  if (d.properties.name === 'Iceland') return [15, 0];
  if (d.properties.name === 'Norway') return [10, -28];
  if (d.properties.name === 'Sweden') return [10, -8];
  if (d.properties.name === 'Finland') return [10, 0];
  if (d.properties.name === 'France') return [-9, 66];
  if (d.properties.name === 'Italy') return [-8, -6];
  if (d.properties.name === 'Russia') return [5, 385];
  // Africa
  if (d.properties.name === 'Madagascar') return [-10, 10];
  // Asia
  if (d.properties.name === 'China') return [-16, -8];
  if (d.properties.name === 'Mongolia') return [-5, 0];
  if (d.properties.name === 'Pakistan') return [-10, 13];
  if (d.properties.name === 'India') return [-11, -18];
  if (d.properties.name === 'Nepal') return [-8, 1];
  if (d.properties.name === 'Myanmar') return [-12, 0];
  if (d.properties.name === 'Laos') return [-12, -8];
  if (d.properties.name === 'Vietnam') return [-12, -4];
  if (d.properties.name === 'Japan') return [5, 5];
  // Oceania
  if (d.properties.name === 'Indonesia') return [0, -5];
  if (d.properties.name === 'Papua New Guinea') return [-5, -10];
  if (d.properties.name === 'Australia') return [-15, 0];
  if (d.properties.name === 'New Zealand') return [-15, 0];
  // otherwise if not specified
  return [-10, 0];
})


// map size settings
//d3.select('body')
//    .style('overflow', 'hidden');

const parentWidth = d3.select('body').node().getBoundingClientRect().width;
//const parentWidth = d3.select('#map').node.getBoundingClientRect().width;
const margin = {top: 0, right: 0, bottom: 0, left: 0};
const width = 800 - margin.left - margin.right;
const height = 420 - margin.top - margin.bottom;

//// color settings
var color = d3.scaleThreshold()
        .domain([20,30,40,50,60,70,80,90,100])
        .range(["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"]);

// place map in html object
const svg = d3.select('body').select('#map')
  .append('svg')
  .attr('width', width)
  .attr('height', height)
  .append('g')
  .attr('class', 'map');

// give the map a nice projection
const projection = d3.geoRobinson()
  .scale(148)
  .rotate([352, 0, 0])
  .translate( [width / 2, height / 2]);

// create path to map projection
const path = d3.geoPath().projection(projection);

// add tooltip
svg.call(tip);

function updateMap(varSelected) {

queue()
  .defer(d3.json, "/static/world_countries.json")
  .await(ready);

function ready(error, geography) {

  var data = {{ data.chart_data | safe }};
  data = data[varSelected];
  console.log(data);

  const colorVariableValueByID = {};

  data.forEach(d => { colorVariableValueByID[d[geoIDVariable]] = d[colorVariable]; });
  geography.features.forEach(d => { d[colorVariable] = colorVariableValueByID[d.id] });

  svg.append('g')
    .attr('class', 'countries')
    .selectAll('path')
    .data(geography.features)
    .enter().append('path')
      .attr('d', path)
      .style('fill', d => {
        if (typeof colorVariableValueByID[d.id] !== 'undefined') {
          return color(colorVariableValueByID[d.id])
        } 
        return 'white'
      })
      .style('fill-opacity',0.8)
      .style('stroke', d => {
          if (d[colorVariable] !== 0) {
          return 'white';
        } 
        return 'lightgray';
      })
      .style('stroke-width', 1)
      .style('stroke-opacity', 0.5)
      // tooltips
      .on('mouseover',function(d){
        tip.show(d);
        d3.select(this)
          .style('fill-opacity', 1)
          .style('stroke-opacity', 1)
          .style('stroke-width', 2)
      })
      .on('mouseout', function(d){
        tip.hide(d);
        d3.select(this)
          .style('fill-opacity', 0.8)
          .style('stroke-opacity', 0.5)
          .style('stroke-width', 1)
      });

  svg.append('path')
    .datum(topojson.mesh(geography.features, (a, b) => a.id !== b.id))
    .attr('class', 'names')
    .attr('d', path);
}

}

updateMap("{{ goodlist[0] }}");

d3.select("#variable")
  .on("change", function() {
    var varSelected = document.getElementById("variable").value;
    updateMap(varSelected);
});

</script>


     
</body>
   


{% endblock %}
